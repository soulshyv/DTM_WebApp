@*@using DTM.Core.Extensions
@using DTM.Core.Utils
@using DTM.Core.ViewModels
@using DTM.DbManager.Enums
@model DTM.Core.ViewModels.CharacterDetailsViewModel
@{
    var perso = Model.Perso;
    var caracs = Model.Caracs;
    var jauges = Model.Jauges;
    var stats = Model.Stats;
    var elements = Model.Elements;
    var skills = Model.Skills;
    var dons = Model.DonsPerso.OrderBy(ob => ob.Taux).ToList();
    var demons = Model.DemonsPerso;
    var inventaire = Model.Inventaire;
}

<h1 class="text-center col-lg-12 col-lg-offset-1">Fiche de personnage</h1>

@if (Model == null)
{
    <h3 class="text-center col-lg-12 col-lg-offset-1">Sélectionnez un personnage dans le tableau pour voir sa fiche complète</h3>
}
else
{
    <div idPerso="detailsPersoScrolling" class="col-lg-12 col-lg-offset-1">
        <div idPerso="detailsPerso">
            <h2 idPerso="nomPerso" class="text-center">@perso.Nom</h2>
            <h3 idPerso="raceperso" class="text-center">@perso.Nom</h3>

            <img class="center-block" idPerso="characPic" src="@Model.CharacterPicture" alt="Image de @perso.Nom" />

            <button class="btn btn-primary center-block" data-toggle="modal" data-target="#modifPic" type="button">Modifier l'image</button>

            <br />

            <table class="table detailsTab">
                <!-- Caractéristiques -->
                <tr class="text-center">
                    <td>Lvl : @perso.Lvl</td>
                    <td>Xp : @perso.Xp</td>
                    <td>Po : @perso.Po</td>
                    <td>Type : @((CharacterTypeEnum)perso.TypePerso)</td>
                </tr>
            </table>

            <button class="btn btn-primary center-block" data-toggle="modal" data-target="#modifCharac" type="button">Modifier les caractéristiques</button>

            <hr />
            
             @if (jauges != null)
             {
                 <table class="table table-bordered detailsTab">
                     <!-- Jauges -->
                     <tr>
                         <th class="text-center">Vie</th>
                         <th class="text-center">Psy</th>
                         <th class="text-center">Synchro</th>
                         <th></th>
                     </tr>
                     <tr class="text-center">
                         <!-- Jauge de vie -->
                         <td class="text-center">
                             @jauges.Vie / @jauges.VieMax
                         </td>
                         <!-- Jauge de psy -->
                         <td class="text-center">
                             @jauges.Psy / @jauges.PsyMax
                         </td>
                         <!-- Jauge de synchro -->
                         <td class="text-center">
                             @jauges.Sync / @jauges.SyncMax
                         </td>
                         <td>
                             <button class="btn btn-primary" data-toggle="modal" data-target="#modifJauges" type="button">Modifier</button>
                         </td>
                     </tr>
                 </table>
             }

            @if (stats != null)
            {
                <table class="table table-bordered detailsTab">
                    <!-- Stats -->
                    <tr>
                        <th class="text-center">Physique</th>
                        <th class="text-center">Mental</th>
                        <th class="text-center">Social</th>
                        <th class="text-center"></th>
                    </tr>
                    <tr class="text-center">
                        <!-- Physique -->
                        <td class="form-group">
                            @stats.Phy %
                        </td>
                        <!-- Mental -->
                        <td class="form-group">
                            @stats.Mental %
                        </td>
                        <!-- Social -->
                        <td class="form-group">
                            @stats.Social %
                        </td>
                        <td width="135px">
                            <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#modifStats" type="button">Modifier</button>
                        </td>
                    </tr>
                </table>

            }
            <table class="table table-bordered detailsTab">
                <tr>
                    <th>Passifs<button class="btn btn-primary pull-right" data-toggle="modal" data-target="#modifPassifs" type="button">Modifier</button></th>
                    <th>Dons<button class="btn btn-primary pull-right" data-toggle="modal" data-target="#modifDons" type="button">Modifier</button></th>
                    <th>Langues<button class="btn btn-primary pull-right" data-toggle="modal" data-target="#modifLangues" type="button" disabled>Modifier</button></th>
                    <th>Or<button class="btn btn-primary pull-right" type="button" disabled>Modifier</button></th>
                </tr>
                <tr>
                    <td>
                        @if (caracs != null)
                        {
                            <span>Attaque : @caracs.Atk<br /></span>
                            <span>Défense : @caracs.Def<br /></span>
                            <span>Rapidité : @caracs.Rap<br /></span>
                        }
                    </td>
                    <td width="300px">
                        @foreach (var d in dons)
                        {
                            var display = d.Don.Description != string.Empty ? ":" + d.Don.Description : string.Empty;
                            <span>[@d.Taux%] @d.Don.Libelle @display<br /></span>
                        }
                    </td>
                    <td></td>
                    <td></td>
                </tr>
            </table>

            @if (skills != null)
            {
                <table class="table table-bordered detailsTab">
                    <tr>
                        <th colspan="4" class="text-center">Skills<button class="btn btn-primary pull-right" data-toggle="modal" data-target="#modifSkills" type="button">Modifier</button></th>
                    </tr>
                    <tr>
                        <th>Nom</th>
                        <th>Description</th>
                        <th>Taux</th>
                        <th>Dégats</th>
                    </tr>
                    @foreach (var sk in skills)
                    {
                        <tr>
                            <td>@sk.Skill.Libelle</td>
                            <td>@sk.Skill.Description</td>
                            <td>@sk.Skill.Taux</td>
                            <td>@sk.Skill.Degats</td>
                        </tr>
                    }
                </table>
            }

            @if (perso.Inventaire != null)
            {
                <table class="table table-bordered detailsTab">
                    <tr>
                        <th colspan="6" class="text-center">Inventaire<button class="btn btn-primary pull-right" data-toggle="modal" data-target="#modifInventaire" type="button">Modifier</button></th>
                    </tr>
                    <tr>
                        <th>Nom</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Quantite</th>
                        <th>Prix</th>
                        <th>Commentaire</th>
                    </tr>


                    @foreach (var item in inventaire.Item)
                    {
                        <tr>
                            <td>@item.Nom</td>
                            <td>@item.Description</td>
                            <td>@((ItemTypeEnum)item.TypeItem)</td>
                            <td>@item.Quantite</td>
                            @if (item.Prix == null)
                            {
                                <td>N/A</td>
                            }
                            else
                            {
                                <td>@item.Prix</td>
                            }
                            <td>@item.Commentaire</td>
                        </tr>
                    }

                </table>
            }
        </div>
    </div>

    <div idPerso="modifPic" class="modal fade modifs" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">Modification de l'image</h4>
                </div>
                <div class="modal-body">
                    <form asp-controller="Characters" asp-action="UpdatePic" method="post" enctype="multipart/form-data">
                        <!-- Image -->
                        <div>
                            <label for="picUpload">Choississez une nouvelle image (png, jpg, gif)</label>
                            <input idPerso="picUpload" name="pic" class="center-block" type="file" />

                            <input type="button" idPerso="btn-submit-file" value="Enregistrer" class="btn btn-primary" data-dismiss="modal"/>
                            <button type="button" class="btn" data-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div idPerso="modifCharac" class="modal fade modifs" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">Modification des caractéristiques</h4>
                </div>
                <div class="modal-body">
                    <form method="post" enctype="multipart/form-data">
                        <!-- Caractéristiques -->
                        <div class="text-center">
                            <label asp-for="@perso.Charac.Nom"></label> <input asp-for="@perso.Charac.Nom" type="text" />
                            <label asp-for="@perso.Charac.Race"></label>
                            <select asp-for="@perso.Charac.Race">
                                @foreach (var r in EnumUtil.GetValues<CharacterRaceEnum>())
                                {
                                    var race = r.ToString();
                                    if (r.ToString() != "NA")
                                    {
                                        race = r.ToString().ToKebabCase();
                                    }

                                    if (race == perso.Charac.Race.ToString())
                                    {
                                        <option selected="selected" value="@race">@race</option>
                                    }
                                    else
                                    {
                                        <option value="@race">@race</option>
                                    }
                                }
                            </select>
                        </div>

                        <br />

                        <table class="table">
                            <tr class="text-center">
                                <td>
                                    <label asp-for="@perso.Charac.Lvl"></label>
                                    <select asp-for="@perso.Charac.Lvl">
                                        @for (var i = 1; i <= 999; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <label asp-for="@perso.Charac.Xp"></label>
                                    <select asp-for="@perso.Charac.Xp">
                                        @for (var i = 0; i <= 99; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <label asp-for="@perso.Charac.Po"></label>
                                    <select asp-for="@perso.Charac.Po">
                                        @for (var i = 0; i <= 999; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <label asp-for="@perso.Charac.TypePerso">Type</label>
                                    <select asp-for="@perso.Charac.TypePerso">
                                        @foreach (var type in EnumUtil.GetValues<CharacterTypeEnum>())
                                        {
                                            if (type == (CharacterTypeEnum) perso.Charac.TypePerso)
                                            {
                                                <option value="@type" selected="selected">@type</option>
                                            }
                                            else
                                            {
                                                <option value="@type">@type</option>
                                            }
                                        }
                                    </select>
                                </td>
                            </tr>
                        </table>
                        <input asp-for="@Model.NomPerso" type="hidden" />

                        <br />

                        <div class="text-center">
                            <button type="button" class="btn btn-primary btn-submit-form" data-dismiss="modal">Enregistrer</button>
                            <button type="button" class="btn" data-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div idPerso="modifJauges" class="modal fade modifs" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">Modification des jauges</h4>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <table class="table table-bordered detailsTab">
                            <!-- Jauges -->
                            <tr class="text-center">
                                <!-- Jauge de vie -->
                                <td class="form-group">
                                    <label asp-for="@perso.Jauges.Pv">Vie : </label>
                                    <select asp-for="@perso.Jauges.Pv">
                                        <option selected="selected" value="none"></option>
                                        @for (var i = 0; i <= 100; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>

                                    <label asp-for="@perso.Jauges.PvMax">/</label>
                                    <select asp-for="@perso.Jauges.PvMax">
                                        <option selected="selected" value="none"></option>
                                        @for (var i = 0; i < 100; i++)
                                        {
                                            <option value="@(i + 1)">@(i + 1)</option>
                                        }
                                    </select>
                                </td>
                                <!-- Jauge de psy -->
                                <td class="form-group">
                                    <label asp-for="@perso.Jauges.Psy">Psy : </label>
                                    <select asp-for="@perso.Jauges.Psy">
                                        <option selected="selected" value="none"></option>
                                        @for (var i = 0; i <= 100; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>

                                    <label asp-for="@perso.Jauges.PsyMax">/</label>
                                    <select asp-for="@perso.Jauges.PsyMax">
                                        <option selected="selected" value="none"></option>
                                        @for (var i = 1; i <= 100; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </td>
                                <!-- Jauge de synchro -->
                                <td class="form-group">
                                    <label asp-for="@perso.Jauges.Synchro">Synchro : </label>
                                    <select asp-for="@perso.Jauges.Synchro">
                                        <option selected="selected" value="none"></option>
                                        @for (var i = 0; i <= 5; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>

                                    <label asp-for="@perso.Jauges.SynchroMax">/</label>
                                    <select asp-for="@perso.Jauges.SynchroMax">
                                        <option selected="selected" value="none"></option>
                                        @for (var i = 1; i <= 5; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </td>
                            </tr>
                        </table>
                        <input asp-for="@Model.NomPerso" type="hidden" />

                        <div class="text-center">
                            <button type="button" class="btn btn-primary btn-submit-form" data-dismiss="modal">Enregistrer</button>
                            <button type="button" class="btn" data-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div idPerso="modifStats" class="modal fade modifs" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">Modification des statistiquess</h4>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <table class="table table-bordered detailsTab">
                            <tr>
                                <th class="text-center">Physique</th>
                                <th class="text-center">Mental</th>
                                <th class="text-center">Social</th>
                            </tr>
                            <tr class="text-center">
                                <!-- Physique -->
                                <td class="form-group">
                                    <select asp-for="@perso.Stats.Physique">
                                        <option value="none"></option>
                                        @for (var i = 0; i <= 100; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                    <label asp-for="@perso.Stats.Physique"> %</label>
                                </td>
                                <!-- Mental -->
                                <td class="form-group">
                                    <select asp-for="@perso.Stats.Mental">
                                        <option value="none"></option>
                                        @for (var i = 0; i <= 100; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                    <label asp-for="@perso.Stats.Mental"> %</label>
                                </td>
                                <!-- Social -->
                                <td class="form-group">
                                    <select asp-for="@perso.Stats.Social">
                                        <option value="none"></option>
                                        @for (var i = 0; i <= 100; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                    <label asp-for="@perso.Stats.Social"> %</label>
                                </td>
                            </tr>
                        </table>
                        <input asp-for="@Model.NomPerso" type="hidden" />

                        <div class="text-center">
                            <button type="button" class="btn btn-primary btn-submit-form" data-dismiss="modal">Enregistrer</button>
                            <button type="button" class="btn" data-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div idPerso="modifPassifs" class="modal fade modifs" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">Modification des passifs</h4>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <table class="table table-bordered">
                            <tr>
                                <td>
                                    <label asp-for="@perso.Caracs.Attaque">Attaque</label>
                                    <select asp-for="@perso.Caracs.Attaque">
                                        @for (var i = 0; i <= 150; i++)
                                        {
                                            if (i == perso.Caracs.Attaque)
                                            {
                                                <option selected="selected" value="@i">@i</option>
                                            }
                                            else
                                            {
                                                <option value="@i">@i</option>
                                            }
                                        }
                                    </select>
                                </td>
                                <td>
                                    <label asp-for="@perso.Caracs.Defense">Défense</label>
                                    <select asp-for="@perso.Caracs.Defense">
                                        @for (var i = 0; i <= 50; i++)
                                        {
                                            if (i == perso.Caracs.Defense)
                                            {
                                                <option selected="selected" value="@i">@i</option>
                                            }
                                            else
                                            {
                                                <option value="@i">@i</option>
                                            }
                                        }
                                    </select>
                                </td>
                                <td>
                                    <label asp-for="@perso.Caracs.Rapidite">Rapidité</label>
                                    <select asp-for="@perso.Caracs.Rapidite">
                                        @for (var i = 0; i <= 50; i++)
                                        {
                                            if (i == perso.Caracs.Rapidite)
                                            {
                                                <option selected="selected" value="@i">@i</option>
                                            }
                                            else
                                            {
                                                <option value="@i">@i</option>
                                            }
                                        }
                                    </select>
                                </td>
                            </tr>
                        </table>
                        <input asp-for="@Model.NomPerso" type="hidden" />

                        <div class="text-center">
                            <button type="button" class="btn btn-primary btn-submit-form" data-dismiss="modal">Enregistrer</button>
                            <button type="button" class="btn" data-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div idPerso="modifDons" class="modal fade modifs" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">Modification des dons</h4>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <table class="table table-bordered detailsTab">
                            <tr>
                                <th class="text-center">Libelle</th>
                                <th class="text-center">Description</th>
                                <th class="text-center">Taux</th>
                            </tr>
                        @{ var donsOrdered = dons.OrderBy(ob => ob.Taux).ToList(); }
                        @for (var i = 0; i < donsOrdered.Count; i++)
                        {
                            <tr class="text-center">
                                <!-- Libelle -->
                                <td class="form-group">
                                    <input asp-for="@donsOrdered[i].Libelle" type="text" />
                                </td>
                                <!-- Description -->
                                <td class="form-group">
                                    <textarea style="resize:none;" asp-for="@donsOrdered[i].Description" type="text">@donsOrdered[i].Description</textarea>
                                </td>
                                <!-- Taux -->
                                <td class="form-group">
                                    <select asp-for="@donsOrdered[i].Taux">
                                @switch (donsOrdered[i].Taux)
                                {
                                    case 10:
                                        <option value="10" selected="selected">10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                        break;

                                    case 15:
                                        <option value="10">10</option>
                                        <option value="15" selected="selected">15</option>
                                        <option value="20">20</option>
                                        break;

                                    case 20:
                                        <option value="10">10</option>
                                        <option value="15">15</option>
                                        <option value="20" selected="selected">20</option>
                                        break;
                                }
                                    </select>
                                </td>
                            </tr>
                        }
                        </table>
                        <input asp-for="@Model.NomPerso" type="hidden" />

                        <div class="text-center">
                            <button type="button" class="btn btn-primary btn-submit-form" data-dismiss="modal">Enregistrer</button>
                            <button type="button" class="btn" data-dismiss="modal">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
}

<script type="text/javascript">
    $(document).ready(function () {
        function loadDetails(nomPerso) {
            $("#details").empty();
            $("#details").load("Characters/GetDetails?nomPerso=" + nomPerso);
        }

        function sleep(delay) {
            var start = new Date().getTime();
            while (new Date().getTime() < start + delay);
        }

        $(".btn-submit-form").click(function () {
            var form = $(this).parent().parent();
            var nomPerso = $(document).find("#nomPerso").text();
            $(".modal-backdrop").remove();
            $.ajax({
                url: "Characters/Update",
                type: "POST",
                data: form.serialize(),
                success: function () {
                loadDetails(nomPerso);
            },
                error: function (message) {
                    console.log(message);
                    alert("Une erreur est survenue à l'enregistrement des données");
                }
            });
        });

        $(".btn-submit-dons").click(function () {
            var form = $(this).parent().parent();
            var nomPerso = $(document).find("#nomPerso").text();
            $(".modal-backdrop").remove();
            $.ajax({
                url: "Characters/PostDonsPerso",
                type: "POST",
                data: form.serialize(),
                success: function () {
                loadDetails(nomPerso);
            },
                error: function (message) {
                    console.log(message);
                    alert("Une erreur est survenue à l'enregistrement des données");
                }
            });
        });

        $("#btn-submit-file").click(function () {
            var fileUpload = $("#picUpload").get(0);
            var files = fileUpload.files;
            var data = new FormData();
            var nomPerso = $(document).find("#nomPerso").text();
            data.append(files[0].name, files[0]);
            data.append("nomPerso", nomPerso);
            console.log(data);
            $(".modal-backdrop").remove();
            $.ajax({
                type: "POST",
                url: "/Characters/UpdatePic",
                contentType: false,
                processData: false,
                data: data,
                success: function (res) {
                    //console.log(res);
                    //$("#characPic").attr("src", res);
                    loadDetails(nomPerso);

                },
                error: function (message) {
                    console.log(message);
                    alert("Une erreur est survenue pendant l'upload du fichier");
                }
            });
        });
    });
</script>*@